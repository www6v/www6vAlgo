<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  AReaL 中的 Off-policyness 与 Partial Rollouts 实现详解
  #


  概述
  #

AReaL 框架通过异步推理和训练分离的架构，实现了高效的分布式 RL 训练。在这个过程中，核心挑战是如何处理：

Off-policyness（策略过时性）：推理引擎使用的模型版本可能落后于训练引擎的版本
Partial Rollouts（部分轨迹）：单个生成序列可能跨越多个模型版本

本文将深入分析 AReaL 如何通过 StalenessManager、版本跟踪机制和 WorkflowExecutor 来管理这些问题。


  1. Off-policyness 控制机制
  #


  1.1 配置参数
  #

AReaL 通过 max_head_offpolicyness 参数控制允许的最大版本差：
rollout:
  max_head_offpolicyness: 4  # 允许推理版本最多落后训练版本 4 步
关键配置说明：

0：同步 RL（推理和训练完全同步，用于调试）
2-8：典型异步范围（根据模型大小和更新频率调整）
更高值：提高吞吐量，但可能降低训练稳定性


  1.2 StalenessManager 核心实现
  #

StalenessManager 是控制 off-policyness 的核心组件，位于 areal/core/staleness_manager.py。

  1.2.1 容量计算公式
  #

def get_capacity(self) -&gt; int:
    &#34;&#34;&#34;计算可用的新 rollout 槽位数量&#34;&#34;&#34;
    with self.lock:
        current_version = self.version_provider.get_version()  # 获取当前训练版本
        
        # 并发限制容量
        max_concurrent_rollouts = max(1, self.max_concurrent_rollouts)
        concurrency_capacity = max_concurrent_rollouts - self.rollout_stat.running
        
        # 过时性限制容量
        ofp = self.max_staleness  # max_head_offpolicyness
        sample_cnt = self.rollout_stat.accepted &#43; self.rollout_stat.running
        consumer_bs = max(1, self.consumer_batch_size)
        staleness_capacity = (ofp &#43; current_version &#43; 1) * consumer_bs - sample_cnt
        
        # 返回两者的最小值
        capacity = min(concurrency_capacity, staleness_capacity)
        return capacity
容量计算逻辑：">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www6v.github.io/www6vAlgo/docs/Agent/infra/AREAL/AREAL-partial-rollout/areal_offpolicyness_analysis/">
  <meta property="og:site_name" content="LLM 算法">
  <meta property="og:title" content="AREAL partial-rollout">
  <meta property="og:description" content="AReaL 中的 Off-policyness 与 Partial Rollouts 实现详解 # 概述 # AReaL 框架通过异步推理和训练分离的架构，实现了高效的分布式 RL 训练。在这个过程中，核心挑战是如何处理：
Off-policyness（策略过时性）：推理引擎使用的模型版本可能落后于训练引擎的版本 Partial Rollouts（部分轨迹）：单个生成序列可能跨越多个模型版本 本文将深入分析 AReaL 如何通过 StalenessManager、版本跟踪机制和 WorkflowExecutor 来管理这些问题。
1. Off-policyness 控制机制 # 1.1 配置参数 # AReaL 通过 max_head_offpolicyness 参数控制允许的最大版本差：
rollout: max_head_offpolicyness: 4 # 允许推理版本最多落后训练版本 4 步 关键配置说明：
0：同步 RL（推理和训练完全同步，用于调试） 2-8：典型异步范围（根据模型大小和更新频率调整） 更高值：提高吞吐量，但可能降低训练稳定性 1.2 StalenessManager 核心实现 # StalenessManager 是控制 off-policyness 的核心组件，位于 areal/core/staleness_manager.py。
1.2.1 容量计算公式 # def get_capacity(self) -&gt; int: &#34;&#34;&#34;计算可用的新 rollout 槽位数量&#34;&#34;&#34; with self.lock: current_version = self.version_provider.get_version() # 获取当前训练版本 # 并发限制容量 max_concurrent_rollouts = max(1, self.max_concurrent_rollouts) concurrency_capacity = max_concurrent_rollouts - self.rollout_stat.running # 过时性限制容量 ofp = self.max_staleness # max_head_offpolicyness sample_cnt = self.rollout_stat.accepted &#43; self.rollout_stat.running consumer_bs = max(1, self.consumer_batch_size) staleness_capacity = (ofp &#43; current_version &#43; 1) * consumer_bs - sample_cnt # 返回两者的最小值 capacity = min(concurrency_capacity, staleness_capacity) return capacity 容量计算逻辑：">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>AREAL partial-rollout | LLM 算法</title>
<link rel="icon" href="/www6vAlgo/favicon.png" >
<link rel="manifest" href="/www6vAlgo/manifest.json">
<link rel="canonical" href="https://www6v.github.io/www6vAlgo/docs/Agent/infra/AREAL/AREAL-partial-rollout/areal_offpolicyness_analysis/">
<link rel="stylesheet" href="/www6vAlgo/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vAlgo/fuse.min.js"></script>
  <script defer src="/www6vAlgo/en.search.min.fb19114d71f1de41b3cc6c910e145980f5e4af8b26aa931f410fa9d46a7c6ece.js" integrity="sha256-&#43;xkRTXHx3kGzzGyRDhRZgPXkr4smqpMfQQ&#43;p1Gp8bs4=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vAlgo/"><span>LLM 算法</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-ca51f083a72ceb6f7ce7aac637ec4cff" class="toggle"  />
    <label for="section-ca51f083a72ceb6f7ce7aac637ec4cff" class="flex justify-between">
      <a role="button" class="">DeepLearning</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ca800fece441ac3e580321c74f3e9d49" class="toggle"  />
    <label for="section-ca800fece441ac3e580321c74f3e9d49" class="flex justify-between">
      <a role="button" class="">basic</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/basic/DeepLearning/" class="">Deep Learning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/basic/DeeplearningForwardBackward/" class="">(原理&amp;实战)前向/反向传播</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/basic/DeeplearningLoss/" class="">(原理&amp;实战)交叉熵损失</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/basic/DeeplearningOverfitting/" class="">(原理)过拟合</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/basic/Pytorch/" class="">(实战)PyTorch</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1a190617d0c8a17ae9ae2d3ed30bd150" class="toggle"  />
    <label for="section-1a190617d0c8a17ae9ae2d3ed30bd150" class="flex justify-between">
      <a role="button" class="">正则化</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E6%AD%A3%E5%88%99%E5%8C%96/WeightDecay/" class="">(原理&amp;实战)权重衰减</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E6%AD%A3%E5%88%99%E5%8C%96/Dropout/" class="">(原理&amp;实战)Dropout</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1424866912bd75b061251f3b3e940596" class="toggle"  />
    <label for="section-1424866912bd75b061251f3b3e940596" class="flex justify-between">
      <a role="button" class="">网络优化</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/DeeplearningLearningRate/" class="">(原理)学习率</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/DeeplearningBatchsize/" class="">(原理)Batchsize</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/DeeplearningNorm/" class="">规范化 Norm</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/DeeplearningGradOpt/" class="">(原理)梯度优化</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d175a581e6d1d294c2886df9f4e638fd" class="toggle"  />
    <label for="section-d175a581e6d1d294c2886df9f4e638fd" class="flex justify-between">
      <a role="button" class="">Transformer</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/Transformer/" class="">(原理)Transformer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/SelfAttention/" class="">(原理)Self-Attention</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/ModelGQA/" class="">(原理)GQA</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/TransformerCode/" class="">(实战)Transformer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/TrainTokenizer/" class="">Tokenizer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-986dec1b5e65fdcdcaa6d6a6bdce0c55" class="toggle"  />
    <label for="section-986dec1b5e65fdcdcaa6d6a6bdce0c55" class="flex justify-between">
      <a role="button" class="">Embedding</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/Embedding/survey/" class="">(Survey)Embedding</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/DeepLearning/Transformer/Embedding/Embedding/" class="">(原理)Embedding</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-47d8239bc563cf0526676851b768f952" class="toggle"  />
    <label for="section-47d8239bc563cf0526676851b768f952" class="flex justify-between">
      <a role="button" class="">机器学习</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/MLData/" class="">机器学习-数据</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/MLModel/" class="">机器学习-模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-4e4529562f8a7b2d9d29129d5ea9bac5" class="toggle" checked />
    <label for="section-4e4529562f8a7b2d9d29129d5ea9bac5" class="flex justify-between">
      <a role="button" class="">Agent</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-60b219d176761004985eb3d1d13b669b" class="toggle"  />
    <label for="section-60b219d176761004985eb3d1d13b669b" class="flex justify-between">
      <a role="button" class="">Deep Research</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f0f072a0394d584d8a25ad8b8d2e588d" class="toggle"  />
    <label for="section-f0f072a0394d584d8a25ad8b8d2e588d" class="flex justify-between">
      <a role="button" class="">Survey</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Survey/Survey/" class="">Survey</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Survey/TongyiDeepresearchNT/" class="">(NT)Tongyi DeepResearch</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2b697507cc5afe0d0d3a9e33baa16d54" class="toggle"  />
    <label for="section-2b697507cc5afe0d0d3a9e33baa16d54" class="flex justify-between">
      <a role="button" class="">Search</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Search/Search-R1/" class="">Search-R1</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Search/websailer/" class="">WebSailor</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Search/Kimi-Researcher/" class="">Kimi-Researcher</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Deep-Research/Search/websailerNT/" class="">WebSailor</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ea73c6f1ab732373f29d955cc823fb27" class="toggle"  />
    <label for="section-ea73c6f1ab732373f29d955cc823fb27" class="flex justify-between">
      <a role="button" class="">Agentic RL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0d41075c5b4525f04c44a1ab283f6633" class="toggle"  />
    <label for="section-0d41075c5b4525f04c44a1ab283f6633" class="flex justify-between">
      <a role="button" class="">Survey</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Agentic-RL/survey/survey/" class="">(Survey)Agentic RL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e93f77db75a578ffc7c9756362505d3f" class="toggle"  />
    <label for="section-e93f77db75a578ffc7c9756362505d3f" class="flex justify-between">
      <a role="button" class="">Tool</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Agentic-RL/Tool/OTC/" class="">OTC</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Agentic-RL/Tool/ReTool/" class="">ReTool</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/Agentic-RL/Tool/ToolRL/" class="">ToolRL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ae322d2a9ee4cad39082f50bf62a89c2" class="toggle" checked />
    <label for="section-ae322d2a9ee4cad39082f50bf62a89c2" class="flex justify-between">
      <a role="button" class="">infra</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/ROLL/" class="">(原理&amp;实践)ROLL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ab5ee90ca06130a7d987b7c7a73b3f78" class="toggle"  />
    <label for="section-ab5ee90ca06130a7d987b7c7a73b3f78" class="flex justify-between">
      <a role="button" class="">verl</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/verl/verl/" class="">HybridFlow[veRL]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/verl/verlA1/" class="">veRL架构[A1]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/verl/veRLConfig/" class="">(原理&amp;实战)veRL Config</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f9253511c5ccbde840cbc205d12226df" class="toggle" checked />
    <label for="section-f9253511c5ccbde840cbc205d12226df" class="flex justify-between">
      <a role="button" class="">AREAL</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/AREAL/AREAL-NT/" class="">(NT)AREAL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/AREAL/AREAL/" class="">(原理|实践)AREAL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/Agent/infra/AREAL/AREAL-partial-rollout/areal_offpolicyness_analysis/" class="active">AREAL partial-rollout</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-8289f046e5a8f2479317b06c48dded09" class="toggle"  />
    <label for="section-8289f046e5a8f2479317b06c48dded09" class="flex justify-between">
      <a role="button" class="">强化学习</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-fd4324249788d4f101352645b9815095" class="toggle"  />
    <label for="section-fd4324249788d4f101352645b9815095" class="flex justify-between">
      <a role="button" class="">Core</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a4b91a8ec30520aa20445e5046653468" class="toggle"  />
    <label for="section-a4b91a8ec30520aa20445e5046653468" class="flex justify-between">
      <a role="button" class="">PPO family</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/PPO-family/PPO/" class="">(原理)PPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/PPO-family/PPO1/" class="">(原理)PPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/PPO-family/RewardModel/" class="">(原理|实现)PPO-RewardModel</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-792edea28c7fa6c149b193954c187e3e" class="toggle"  />
    <label for="section-792edea28c7fa6c149b193954c187e3e" class="flex justify-between">
      <a role="button" class="">GRPO Family</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/GRPO-family/GRPODeepseek/" class="">(实战)GRPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/GRPO-family/GRPO/" class="">(原理)GRPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/GRPO-family/DAPO/" class="">(原理)DAPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/compare/" class="">(原理) 综述</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/DPO/" class="">(原理|实现)DPO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/unified/" class="">unified paradigm</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/RL/core/RLVR/" class="">RLVR</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-74da2f7bc7a3fb6c948028291efa6462" class="toggle"  />
    <label for="section-74da2f7bc7a3fb6c948028291efa6462" class="flex justify-between">
      <a role="button" class="">LLM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-50717b22c392318484ed92082d544dd2" class="toggle"  />
    <label for="section-50717b22c392318484ed92082d544dd2" class="flex justify-between">
      <a role="button" class="">Survey</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Survey/LargeModelSurvey/" class="">(综述)大模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Survey/LargeModel/" class="">大模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Survey/LLM-Deep-Dive/" class="">LLM Deep Dive</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Survey/LLM-Compare/" class="">LLM架构演进</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Survey/LeaderBoard/" class="">大模型 排行榜</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-fb69e8f04a6f9bb8fb43ebdb9607c2d9" class="toggle"  />
    <label for="section-fb69e8f04a6f9bb8fb43ebdb9607c2d9" class="flex justify-between">
      <a role="button" class="">Dense</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Dense/Family/" class="">GPT 系列</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Dense/Llama/" class="">LLaMA</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Dense/LlamaFamily/" class="">LLaMA 家族</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Dense/Llama3-1/" class="">Llama3.1</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Dense/BERT/" class="">(原理)BERT</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-00115c923a3b56db78447633045b86e5" class="toggle"  />
    <label for="section-00115c923a3b56db78447633045b86e5" class="flex justify-between">
      <a role="button" class="">Reasoning</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-eb6efb7e57d9b3bd5d67d76eb45cf382" class="toggle"  />
    <label for="section-eb6efb7e57d9b3bd5d67d76eb45cf382" class="flex justify-between">
      <a role="button" class="">Survey</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Survey/ReasoningTTS/" class="">(Survey) Test-Time Scaling</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Survey/ReasoningPostTraining/" class="">(Survey)Reasoning LLM Post-Training</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1a4f5c4ee7bee807e0e4278f7f7d8719" class="toggle"  />
    <label for="section-1a4f5c4ee7bee807e0e4278f7f7d8719" class="flex justify-between">
      <a role="button" class="">Qwen</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Qwen/Qwen3/" class="">Qwen3</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Qwen/Qwen3-report/" class="">Qwen3 Report</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Qwen/qwen-next/" class="">(原理)Qwen3-Next</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4a652c2712b37ada613861578ed20563" class="toggle"  />
    <label for="section-4a652c2712b37ada613861578ed20563" class="flex justify-between">
      <a role="button" class="">Deepseek</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-48f04557895a93e37ea069284a46fb42" class="toggle"  />
    <label for="section-48f04557895a93e37ea069284a46fb42" class="flex justify-between">
      <a role="button" class="">Post-training</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/post-training/DeepseekDistill/" class="">(实战)Deepseek 蒸馏</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/post-training/DeepseekSFT/" class="">(实战)Deepseek R1 SFT</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3e1c0837357e9aacf6d05cbed5dc4d1f" class="toggle"  />
    <label for="section-3e1c0837357e9aacf6d05cbed5dc4d1f" class="flex justify-between">
      <a role="button" class="">R1</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/R1/DeepSeekExplain2/" class="">解读 DeepSeek[邱锡鹏]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/R1/DeepSeekExplain1/" class="">解读 DeepSeek[刘知远]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/R1/ReasoningLLM/" class="">(原理)Reasoning LLM</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/R1/DeepSeekR1/" class="">(原理) DeepSeek R1</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1e90ca9a2107f4bd9f4516a445b1bdcf" class="toggle"  />
    <label for="section-1e90ca9a2107f4bd9f4516a445b1bdcf" class="flex justify-between">
      <a role="button" class="">V3</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Deepseek/V3/DeepSeek/" class="">DeepSeek V3</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d9743338127b6aab5ee87bc9bc97be5e" class="toggle"  />
    <label for="section-d9743338127b6aab5ee87bc9bc97be5e" class="flex justify-between">
      <a role="button" class="">kimi</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/kimi/k2/" class="">(翻译)kimi k2</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/kimi/k2-thinking/" class="">Kimi K2 Thinking</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/kimi/1.5/" class="">Kimi1.5</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/kimi/K2A1/" class="">(A1)K2 论文</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6d0afc3f46dbf37aaf932c7a930559a9" class="toggle"  />
    <label for="section-6d0afc3f46dbf37aaf932c7a930559a9" class="flex justify-between">
      <a role="button" class="">Overthinking</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Reasoning/Overthinking/survey/" class="">(Survey)Overthinking</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5366419f34f701d933f9513a09b5b014" class="toggle"  />
    <label for="section-5366419f34f701d933f9513a09b5b014" class="flex justify-between">
      <a role="button" class="">快慢思考</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-69a7d42415bc536b90d48518db8c889c" class="toggle"  />
    <label for="section-69a7d42415bc536b90d48518db8c889c" class="flex justify-between">
      <a role="button" class="">MOE</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/MoE/ModelMOE/" class="">(原理)Visual  MOE</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/MoE/ModelMOECode/" class="">(代码)MOE</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/MoE/MoE/" class="">(原理)MoE</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d3ad2ad02a69d9fe3f2c5be5fef9a925" class="toggle"  />
    <label for="section-d3ad2ad02a69d9fe3f2c5be5fef9a925" class="flex justify-between">
      <a role="button" class="">Core</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Core/ScalingLaw/" class="">Scaling Law</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Core/Emergent/" class="">(原理)涌现现象</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Core/Eval/" class="">测评 *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-49880184e06fd9cedeebad822a47bb36" class="toggle"  />
    <label for="section-49880184e06fd9cedeebad822a47bb36" class="flex justify-between">
      <a role="button" class="">Token Sampling</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Core/token-sampling/token-sampling/" class="">(翻译)token sampling</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/Core/token-sampling/temperature/" class="">Token Sampling Methods</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dcc7208d3f790b5592723fa605667723" class="toggle"  />
    <label for="section-dcc7208d3f790b5592723fa605667723" class="flex justify-between">
      <a role="button" class="">Challenge</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/challenge/Hallucination/" class="">(原理)幻觉问题</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAlgo/docs/LLM/challenge/ImpossibleTriangle/" class="">(原理)不可能三角</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vAlgo/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>AREAL partial-rollout</h3>

  <label for="toc-control">
    
    <img src="/www6vAlgo/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#areal-中的-off-policyness-与-partial-rollouts-实现详解">AReaL 中的 Off-policyness 与 Partial Rollouts 实现详解</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#1-off-policyness-控制机制">1. Off-policyness 控制机制</a>
          <ul>
            <li><a href="#11-配置参数">1.1 配置参数</a></li>
            <li><a href="#12-stalenessmanager-核心实现">1.2 StalenessManager 核心实现</a></li>
          </ul>
        </li>
        <li><a href="#2-partial-rollouts部分轨迹实现">2. Partial Rollouts（部分轨迹）实现</a>
          <ul>
            <li><a href="#21-版本跟踪机制">2.1 版本跟踪机制</a></li>
            <li><a href="#22-workflow-中的版本处理">2.2 Workflow 中的版本处理</a></li>
          </ul>
        </li>
        <li><a href="#3-异步任务调度与分发">3. 异步任务调度与分发</a>
          <ul>
            <li><a href="#31-batchtaskdispatcher-架构">3.1 BatchTaskDispatcher 架构</a></li>
            <li><a href="#32-生产者线程容量感知的任务提交">3.2 生产者线程：容量感知的任务提交</a></li>
            <li><a href="#33-消费者线程结果收集">3.3 消费者线程：结果收集</a></li>
          </ul>
        </li>
        <li><a href="#4-完整流程图">4. 完整流程图</a>
          <ul>
            <li><a href="#41-off-policyness-控制流程">4.1 Off-policyness 控制流程</a></li>
            <li><a href="#42-partial-rollouts-处理流程">4.2 Partial Rollouts 处理流程</a></li>
            <li><a href="#43-版本信息在轨迹中的流动">4.3 版本信息在轨迹中的流动</a></li>
          </ul>
        </li>
        <li><a href="#5-decoupled-ppo-目标函数">5. Decoupled PPO 目标函数</a>
          <ul>
            <li><a href="#51-配置">5.1 配置</a></li>
            <li><a href="#52-三种-log-probability">5.2 三种 Log-Probability</a></li>
            <li><a href="#53-decoupled-损失计算">5.3 Decoupled 损失计算</a></li>
          </ul>
        </li>
        <li><a href="#6-系统整体流程图">6. 系统整体流程图</a></li>
        <li><a href="#7-关键设计要点总结">7. 关键设计要点总结</a>
          <ul>
            <li><a href="#71-off-policyness-控制">7.1 Off-policyness 控制</a></li>
            <li><a href="#72-partial-rollouts-支持">7.2 Partial Rollouts 支持</a></li>
            <li><a href="#73-异步架构优势">7.3 异步架构优势</a></li>
          </ul>
        </li>
        <li><a href="#8-配置建议">8. 配置建议</a>
          <ul>
            <li><a href="#81-调试场景">8.1 调试场景</a></li>
            <li><a href="#82-高吞吐量场景">8.2 高吞吐量场景</a></li>
            <li><a href="#83-稳定性优先场景">8.3 稳定性优先场景</a></li>
          </ul>
        </li>
        <li><a href="#9-参考资料">9. 参考资料</a></li>
        <li><a href="#附录代码示例">附录：代码示例</a>
          <ul>
            <li><a href="#a1-完整的训练循环示例">A.1 完整的训练循环示例</a></li>
            <li><a href="#a2-自定义-workflow-示例">A.2 自定义 Workflow 示例</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="areal-中的-off-policyness-与-partial-rollouts-实现详解">
  AReaL 中的 Off-policyness 与 Partial Rollouts 实现详解
  <a class="anchor" href="#areal-%e4%b8%ad%e7%9a%84-off-policyness-%e4%b8%8e-partial-rollouts-%e5%ae%9e%e7%8e%b0%e8%af%a6%e8%a7%a3">#</a>
</h1>
<h2 id="概述">
  概述
  <a class="anchor" href="#%e6%a6%82%e8%bf%b0">#</a>
</h2>
<p>AReaL 框架通过<strong>异步推理和训练分离</strong>的架构，实现了高效的分布式 RL 训练。在这个过程中，核心挑战是如何处理：</p>
<ol>
<li><strong>Off-policyness（策略过时性）</strong>：推理引擎使用的模型版本可能落后于训练引擎的版本</li>
<li><strong>Partial Rollouts（部分轨迹）</strong>：单个生成序列可能跨越多个模型版本</li>
</ol>
<p>本文将深入分析 AReaL 如何通过 <code>StalenessManager</code>、版本跟踪机制和 <code>WorkflowExecutor</code> 来管理这些问题。</p>
<hr>
<h2 id="1-off-policyness-控制机制">
  1. Off-policyness 控制机制
  <a class="anchor" href="#1-off-policyness-%e6%8e%a7%e5%88%b6%e6%9c%ba%e5%88%b6">#</a>
</h2>
<h3 id="11-配置参数">
  1.1 配置参数
  <a class="anchor" href="#11-%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0">#</a>
</h3>
<p>AReaL 通过 <code>max_head_offpolicyness</code> 参数控制允许的最大版本差：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rollout</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_head_offpolicyness</span>: <span style="color:#ae81ff">4</span>  <span style="color:#75715e"># 允许推理版本最多落后训练版本 4 步</span>
</span></span></code></pre></div><p><strong>关键配置说明</strong>：</p>
<ul>
<li><code>0</code>：同步 RL（推理和训练完全同步，用于调试）</li>
<li><code>2-8</code>：典型异步范围（根据模型大小和更新频率调整）</li>
<li>更高值：提高吞吐量，但可能降低训练稳定性</li>
</ul>
<h3 id="12-stalenessmanager-核心实现">
  1.2 StalenessManager 核心实现
  <a class="anchor" href="#12-stalenessmanager-%e6%a0%b8%e5%bf%83%e5%ae%9e%e7%8e%b0">#</a>
</h3>
<p><code>StalenessManager</code> 是控制 off-policyness 的核心组件，位于 <code>areal/core/staleness_manager.py</code>。</p>
<h4 id="121-容量计算公式">
  1.2.1 容量计算公式
  <a class="anchor" href="#121-%e5%ae%b9%e9%87%8f%e8%ae%a1%e7%ae%97%e5%85%ac%e5%bc%8f">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_capacity</span>(self) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;计算可用的新 rollout 槽位数量&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>lock:
</span></span><span style="display:flex;"><span>        current_version <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>version_provider<span style="color:#f92672">.</span>get_version()  <span style="color:#75715e"># 获取当前训练版本</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 并发限制容量</span>
</span></span><span style="display:flex;"><span>        max_concurrent_rollouts <span style="color:#f92672">=</span> max(<span style="color:#ae81ff">1</span>, self<span style="color:#f92672">.</span>max_concurrent_rollouts)
</span></span><span style="display:flex;"><span>        concurrency_capacity <span style="color:#f92672">=</span> max_concurrent_rollouts <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>running
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 过时性限制容量</span>
</span></span><span style="display:flex;"><span>        ofp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_staleness  <span style="color:#75715e"># max_head_offpolicyness</span>
</span></span><span style="display:flex;"><span>        sample_cnt <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>accepted <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>running
</span></span><span style="display:flex;"><span>        consumer_bs <span style="color:#f92672">=</span> max(<span style="color:#ae81ff">1</span>, self<span style="color:#f92672">.</span>consumer_batch_size)
</span></span><span style="display:flex;"><span>        staleness_capacity <span style="color:#f92672">=</span> (ofp <span style="color:#f92672">+</span> current_version <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> consumer_bs <span style="color:#f92672">-</span> sample_cnt
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 返回两者的最小值</span>
</span></span><span style="display:flex;"><span>        capacity <span style="color:#f92672">=</span> min(concurrency_capacity, staleness_capacity)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> capacity
</span></span></code></pre></div><p><strong>容量计算逻辑</strong>：</p>
<ol>
<li>
<p><strong>并发容量</strong>：<code>max_concurrent_rollouts - running_rollouts</code></p>
<ul>
<li>限制同时运行的 rollout 数量</li>
</ul>
</li>
<li>
<p><strong>过时性容量</strong>：<code>(max_staleness + current_version + 1) × batch_size - current_samples</code></p>
<ul>
<li>确保样本被消费时不会超过最大允许的过时性</li>
<li><code>current_version + 1</code>：预测下一个训练步骤的版本</li>
<li>乘以 <code>batch_size</code>：每个版本可以有一个完整批次的样本</li>
</ul>
</li>
<li>
<p><strong>最终容量</strong>：取两者最小值，确保同时满足两个约束</p>
</li>
</ol>
<h4 id="122-rollout-生命周期跟踪">
  1.2.2 Rollout 生命周期跟踪
  <a class="anchor" href="#122-rollout-%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e8%b7%9f%e8%b8%aa">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StalenessManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_rollout_enqueued</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Rollout 任务入队&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>lock:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>enqueued <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_rollout_submitted</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Rollout 任务提交执行&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>lock:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>enqueued <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>running <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_rollout_accepted</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Rollout 完成并被接受&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>lock:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>running <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>accepted <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_rollout_rejected</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Rollout 完成但被拒绝&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>lock:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>running <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>rollout_stat<span style="color:#f92672">.</span>rejected <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>状态转换图</strong>：</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">stateDiagram-v2
    [*] --&gt; Enqueued: 任务提交
    Enqueued --&gt; Running: 开始执行
    Running --&gt; Accepted: 完成并通过筛选
    Running --&gt; Rejected: 完成但被拒绝/失败
    Accepted --&gt; [*]
    Rejected --&gt; [*]
</code></pre><hr>
<h2 id="2-partial-rollouts部分轨迹实现">
  2. Partial Rollouts（部分轨迹）实现
  <a class="anchor" href="#2-partial-rollouts%e9%83%a8%e5%88%86%e8%bd%a8%e8%bf%b9%e5%ae%9e%e7%8e%b0">#</a>
</h2>
<h3 id="21-版本跟踪机制">
  2.1 版本跟踪机制
  <a class="anchor" href="#21-%e7%89%88%e6%9c%ac%e8%b7%9f%e8%b8%aa%e6%9c%ba%e5%88%b6">#</a>
</h3>
<p>AReaL 通过在生成过程中记录每个 token 的模型版本来支持 partial rollouts。</p>
<h4 id="211-modelresponse-结构">
  2.1.1 ModelResponse 结构
  <a class="anchor" href="#211-modelresponse-%e7%bb%93%e6%9e%84">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ModelResponse</span>:
</span></span><span style="display:flex;"><span>    input_tokens: list[int] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>list)
</span></span><span style="display:flex;"><span>    output_tokens: list[int] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>list)
</span></span><span style="display:flex;"><span>    output_logprobs: list[float] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>list)
</span></span><span style="display:flex;"><span>    output_versions: list[int] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>list)  <span style="color:#75715e"># 每个 token 的版本号</span>
</span></span><span style="display:flex;"><span>    stop_reason: Literal[<span style="color:#e6db74">&#34;length&#34;</span>, <span style="color:#e6db74">&#34;stop&#34;</span>, <span style="color:#e6db74">&#34;tool_calls&#34;</span>, <span style="color:#e6db74">&#34;abort&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stop&#34;</span>
</span></span></code></pre></div><p><strong>关键字段</strong>：</p>
<ul>
<li><code>output_versions</code>：与 <code>output_tokens</code> 长度相同的列表，记录每个 token 生成时的模型版本</li>
</ul>
<h4 id="212-增量生成与版本记录">
  2.1.2 增量生成与版本记录
  <a class="anchor" href="#212-%e5%a2%9e%e9%87%8f%e7%94%9f%e6%88%90%e4%b8%8e%e7%89%88%e6%9c%ac%e8%ae%b0%e5%bd%95">#</a>
</h4>
<p>在 <code>RemoteInfEngine.agenerate</code> 中实现增量生成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">agenerate</span>(self, req: ModelRequest) <span style="color:#f92672">-&gt;</span> ModelResponse:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    处理可能被权重更新中断的生成请求。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    如果生成过程中发生权重更新，会继续从中断处生成，
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    并记录每个阶段的模型版本。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    output_tokens <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    output_logprobs <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    output_versions <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    stop_reason <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    max_new_tokens <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span>gconfig<span style="color:#f92672">.</span>max_new_tokens
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> stop_reason <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;stop&#34;</span> <span style="color:#f92672">and</span> len(output_tokens) <span style="color:#f92672">&lt;</span> max_new_tokens:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 如果之前被中断，等待一段时间避免资源竞争</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> stop_reason <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 发送 HTTP 请求到推理服务器</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> arequest_with_retry(
</span></span><span style="display:flex;"><span>            addr<span style="color:#f92672">=</span>server_addr,
</span></span><span style="display:flex;"><span>            endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/generate&#34;</span>,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload,
</span></span><span style="display:flex;"><span>            method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 累积输出</span>
</span></span><span style="display:flex;"><span>        new_tokens <span style="color:#f92672">=</span> result[<span style="color:#e6db74">&#34;output_ids&#34;</span>]
</span></span><span style="display:flex;"><span>        output_tokens<span style="color:#f92672">.</span>extend(new_tokens)
</span></span><span style="display:flex;"><span>        output_logprobs<span style="color:#f92672">.</span>extend(result[<span style="color:#e6db74">&#34;logprobs&#34;</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 记录当前版本号（所有新生成的 token 使用相同版本）</span>
</span></span><span style="display:flex;"><span>        current_version <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_version()
</span></span><span style="display:flex;"><span>        output_versions<span style="color:#f92672">.</span>extend([current_version] <span style="color:#f92672">*</span> len(new_tokens))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 更新请求以继续生成</span>
</span></span><span style="display:flex;"><span>        payload[<span style="color:#e6db74">&#34;input_ids&#34;</span>] <span style="color:#f92672">+=</span> new_tokens
</span></span><span style="display:flex;"><span>        payload[<span style="color:#e6db74">&#34;sample_params&#34;</span>][<span style="color:#e6db74">&#34;max_new_tokens&#34;</span>] <span style="color:#f92672">-=</span> len(new_tokens)
</span></span><span style="display:flex;"><span>        stop_reason <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;stop_reason&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ModelResponse(
</span></span><span style="display:flex;"><span>        input_tokens<span style="color:#f92672">=</span>req<span style="color:#f92672">.</span>input_ids,
</span></span><span style="display:flex;"><span>        output_tokens<span style="color:#f92672">=</span>output_tokens,
</span></span><span style="display:flex;"><span>        output_logprobs<span style="color:#f92672">=</span>output_logprobs,
</span></span><span style="display:flex;"><span>        output_versions<span style="color:#f92672">=</span>output_versions,  <span style="color:#75715e"># 版本信息</span>
</span></span><span style="display:flex;"><span>        stop_reason<span style="color:#f92672">=</span>stop_reason
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><h3 id="22-workflow-中的版本处理">
  2.2 Workflow 中的版本处理
  <a class="anchor" href="#22-workflow-%e4%b8%ad%e7%9a%84%e7%89%88%e6%9c%ac%e5%a4%84%e7%90%86">#</a>
</h3>
<p>以 <code>MultiTurnWorkflow</code> 为例，展示如何在多轮对话中累积版本信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MultiTurnWorkflow</span>(RolloutWorkflow):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">arun_episode</span>(self, engine: InferenceEngine, data: dict[str, Any]):
</span></span><span style="display:flex;"><span>        seq, logprobs, loss_mask, versions <span style="color:#f92672">=</span> [], [], [], []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>max_turns):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 发送生成请求</span>
</span></span><span style="display:flex;"><span>            req <span style="color:#f92672">=</span> ModelRequest(<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>            resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> engine<span style="color:#f92672">.</span>agenerate(req)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 累积结果，注意版本信息的处理</span>
</span></span><span style="display:flex;"><span>            input_len <span style="color:#f92672">=</span> len(resp<span style="color:#f92672">.</span>input_tokens) <span style="color:#f92672">-</span> len(seq)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 拼接序列</span>
</span></span><span style="display:flex;"><span>            seq <span style="color:#f92672">+=</span> resp<span style="color:#f92672">.</span>input_tokens[<span style="color:#f92672">-</span>input_len:] <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_tokens
</span></span><span style="display:flex;"><span>            logprobs <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> input_len <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_logprobs
</span></span><span style="display:flex;"><span>            loss_mask <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> input_len <span style="color:#f92672">+</span> [<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> resp<span style="color:#f92672">.</span>output_len
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 拼接版本信息：prompt 部分标记为 -1，completion 部分使用实际版本</span>
</span></span><span style="display:flex;"><span>            versions <span style="color:#f92672">+=</span> [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> input_len <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_versions
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 检查是否需要继续</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> reward <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 返回包含版本信息的轨迹</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;input_ids&#34;</span>: torch<span style="color:#f92672">.</span>tensor(seq, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;logprobs&#34;</span>: torch<span style="color:#f92672">.</span>tensor(logprobs, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;loss_mask&#34;</span>: torch<span style="color:#f92672">.</span>tensor(loss_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;versions&#34;</span>: torch<span style="color:#f92672">.</span>tensor(versions, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),  <span style="color:#75715e"># 版本张量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;rewards&#34;</span>: torch<span style="color:#f92672">.</span>tensor(reward, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attention_mask&#34;</span>: torch<span style="color:#f92672">.</span>ones(len(seq), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p><strong>版本标记约定</strong>：</p>
<ul>
<li><code>-1</code>：prompt 部分（不需要计算损失）</li>
<li><code>&gt;= 0</code>：completion 部分的实际模型版本号</li>
</ul>
<hr>
<h2 id="3-异步任务调度与分发">
  3. 异步任务调度与分发
  <a class="anchor" href="#3-%e5%bc%82%e6%ad%a5%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6%e4%b8%8e%e5%88%86%e5%8f%91">#</a>
</h2>
<h3 id="31-batchtaskdispatcher-架构">
  3.1 BatchTaskDispatcher 架构
  <a class="anchor" href="#31-batchtaskdispatcher-%e6%9e%b6%e6%9e%84">#</a>
</h3>
<p><code>BatchTaskDispatcher</code> 使用生产者-消费者模式管理异步任务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BatchTaskDispatcher</span>[TInput: WithTaskID, TResult]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    通用的异步任务分发器，支持过时性控制。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    架构：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - 生产者线程：根据过时性容量从 _pending_inputs 提交任务到 AsyncTaskRunner
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - 消费者线程：从 AsyncTaskRunner 收集结果到 _pending_results
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - 主线程：submit_task_input() 入队，wait_results() 等待结果
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        max_queue_size: int,
</span></span><span style="display:flex;"><span>        task_factory: Callable[[TInput], Callable[[], Awaitable[TResult <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>]]],
</span></span><span style="display:flex;"><span>        staleness_manager: StalenessManager,
</span></span><span style="display:flex;"><span>        enable_tracing: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>runner <span style="color:#f92672">=</span> AsyncTaskRunner(max_queue_size<span style="color:#f92672">=</span>max_queue_size)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>staleness_manager <span style="color:#f92672">=</span> staleness_manager
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 无界队列用于生产者-消费者模式</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_pending_inputs: deque[TInput] <span style="color:#f92672">=</span> deque()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_pending_results: dict[int, TimedResult[TResult]] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 线程同步</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_input_lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_input_cv <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Condition(self<span style="color:#f92672">.</span>_input_lock)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_result_lock <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Lock()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_result_cv <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Condition(self<span style="color:#f92672">.</span>_result_lock)
</span></span></code></pre></div><h3 id="32-生产者线程容量感知的任务提交">
  3.2 生产者线程：容量感知的任务提交
  <a class="anchor" href="#32-%e7%94%9f%e4%ba%a7%e8%80%85%e7%ba%bf%e7%a8%8b%e5%ae%b9%e9%87%8f%e6%84%9f%e7%9f%a5%e7%9a%84%e4%bb%bb%e5%8a%a1%e6%8f%90%e4%ba%a4">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_commit_loop</span>(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;生产者线程 - 根据容量持续提交任务&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_shutdown_event<span style="color:#f92672">.</span>is_set():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 获取下一个待提交任务</span>
</span></span><span style="display:flex;"><span>            task_input <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_next_task_for_submission()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> task_input <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 提交到 AsyncTaskRunner</span>
</span></span><span style="display:flex;"><span>            task_fn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>task_factory(task_input)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>runner<span style="color:#f92672">.</span>submit(task_fn, task_id<span style="color:#f92672">=</span>task_input<span style="color:#f92672">.</span>task_id)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>staleness_manager<span style="color:#f92672">.</span>on_rollout_submitted()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> TaskQueueFullError:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 队列满，重新入队并等待容量</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_input_cv:
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>_pending_inputs<span style="color:#f92672">.</span>appendleft(task_input)
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>_input_cv<span style="color:#f92672">.</span>wait_for(
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">lambda</span>: self<span style="color:#f92672">.</span>_shutdown_event<span style="color:#f92672">.</span>is_set() <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>_has_runner_capacity()
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Producer thread failed&#34;</span>, exc_info<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_set_thread_exception(e)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_next_task_for_submission</span>(self) <span style="color:#f92672">-&gt;</span> TInput <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;获取下一个可提交的任务，考虑容量限制&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_input_cv:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_shutdown_event<span style="color:#f92672">.</span>is_set():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 检查是否有容量且有待处理任务</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>runner<span style="color:#f92672">.</span>paused<span style="color:#f92672">.</span>is_set()
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>staleness_manager<span style="color:#f92672">.</span>get_capacity() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 过时性容量检查</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>_pending_inputs
</span></span><span style="display:flex;"><span>            ):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_pending_inputs<span style="color:#f92672">.</span>popleft()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_input_cv<span style="color:#f92672">.</span>wait()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span></code></pre></div><h3 id="33-消费者线程结果收集">
  3.3 消费者线程：结果收集
  <a class="anchor" href="#33-%e6%b6%88%e8%b4%b9%e8%80%85%e7%ba%bf%e7%a8%8b%e7%bb%93%e6%9e%9c%e6%94%b6%e9%9b%86">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_fetch_loop</span>(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;消费者线程 - 持续从 runner 收集结果&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_shutdown_event<span style="color:#f92672">.</span>is_set():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 轮询可用结果（非阻塞）</span>
</span></span><span style="display:flex;"><span>            output_queue_size <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>runner<span style="color:#f92672">.</span>get_output_queue_size()
</span></span><span style="display:flex;"><span>            count <span style="color:#f92672">=</span> max(<span style="color:#ae81ff">1</span>, min(output_queue_size, _MAX_FETCH_BATCH_SIZE))
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 使用短超时以保持响应性</span>
</span></span><span style="display:flex;"><span>                results <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>runner<span style="color:#f92672">.</span>wait(count<span style="color:#f92672">=</span>count, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.05</span>, with_timing<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">TimeoutError</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 将结果放入待处理队列</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_result_cv:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> result <span style="color:#f92672">in</span> results:
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>_pending_results[result<span style="color:#f92672">.</span>task_id] <span style="color:#f92672">=</span> result
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_result_cv<span style="color:#f92672">.</span>notify_all()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 新容量可用，唤醒生产者</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>_input_cv:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_input_cv<span style="color:#f92672">.</span>notify()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Consumer thread failed&#34;</span>, exc_info<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_set_thread_exception(e)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span></code></pre></div><hr>
<h2 id="4-完整流程图">
  4. 完整流程图
  <a class="anchor" href="#4-%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b%e5%9b%be">#</a>
</h2>
<h3 id="41-off-policyness-控制流程">
  4.1 Off-policyness 控制流程
  <a class="anchor" href="#41-off-policyness-%e6%8e%a7%e5%88%b6%e6%b5%81%e7%a8%8b">#</a>
</h3>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">sequenceDiagram
    participant Main as 主线程
    participant Dispatcher as BatchTaskDispatcher
    participant Producer as 生产者线程
    participant SM as StalenessManager
    participant Runner as AsyncTaskRunner
    participant Consumer as 消费者线程
    participant Workflow as RolloutWorkflow
    
    Main-&gt;&gt;Dispatcher: submit_task_input(task)
    Dispatcher-&gt;&gt;SM: on_rollout_enqueued()
    Note over SM: enqueued++
    Dispatcher-&gt;&gt;Dispatcher: _pending_inputs.append(task)
    
    Producer-&gt;&gt;SM: get_capacity()
    SM--&gt;&gt;Producer: capacity = min(concurrency_cap, staleness_cap)
    
    alt capacity &gt; 0
        Producer-&gt;&gt;Dispatcher: _pending_inputs.popleft()
        Producer-&gt;&gt;Runner: submit(task_fn)
        Producer-&gt;&gt;SM: on_rollout_submitted()
        Note over SM: enqueued--, running++
        
        Runner-&gt;&gt;Workflow: arun_episode(engine, data)
        
        alt 生成中权重更新
            Workflow-&gt;&gt;Workflow: 记录版本 v1
            Note over Workflow: 权重更新中断
            Workflow-&gt;&gt;Workflow: 等待并继续
            Workflow-&gt;&gt;Workflow: 记录版本 v2
        end
        
        Workflow--&gt;&gt;Runner: trajectory (with versions)
        Runner--&gt;&gt;Consumer: result ready
        
        Consumer-&gt;&gt;Dispatcher: _pending_results[task_id] = result
        Consumer-&gt;&gt;SM: on_rollout_accepted()
        Note over SM: running--, accepted++
    else capacity &lt;= 0
        Producer-&gt;&gt;Producer: wait for capacity
    end
    
    Main-&gt;&gt;Dispatcher: wait_results(count)
    Dispatcher-&gt;&gt;Main: [trajectory1, trajectory2, ...]
</code></pre><h3 id="42-partial-rollouts-处理流程">
  4.2 Partial Rollouts 处理流程
  <a class="anchor" href="#42-partial-rollouts-%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b">#</a>
</h3>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TB
    Start([开始生成请求]) --&gt; InitVersion[记录初始版本 v0]
    InitVersion --&gt; GenLoop{继续生成?}
    
    GenLoop --&gt;|是| SendReq[发送生成请求到推理服务器]
    SendReq --&gt; CheckStop{检查 stop_reason}
    
    CheckStop --&gt;|中断: weight_update| Wait[等待 0.5s&lt;br/&gt;避免资源竞争]
    Wait --&gt; UpdateVersion[更新版本到 v1]
    UpdateVersion --&gt; RecordV1[为新 tokens 记录版本 v1]
    RecordV1 --&gt; UpdatePayload[更新 payload&lt;br/&gt;继续生成]
    UpdatePayload --&gt; GenLoop
    
    CheckStop --&gt;|正常| RecordV0[为新 tokens 记录版本 v0]
    RecordV0 --&gt; CheckComplete{达到长度限制?}
    CheckComplete --&gt;|否| UpdatePayload
    CheckComplete --&gt;|是| BuildResp[构建 ModelResponse]
    
    GenLoop --&gt;|否: stop 或达到长度| BuildResp
    
    BuildResp --&gt; ReturnResp[返回包含:&lt;br/&gt;- output_tokens&lt;br/&gt;- output_logprobs&lt;br/&gt;- output_versions]
    ReturnResp --&gt; End([结束])
    
    style Wait fill:#ffe6e6
    style UpdateVersion fill:#fff4e6
    style RecordV1 fill:#fff4e6
    style RecordV0 fill:#e6f7ff
</code></pre><h3 id="43-版本信息在轨迹中的流动">
  4.3 版本信息在轨迹中的流动
  <a class="anchor" href="#43-%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af%e5%9c%a8%e8%bd%a8%e8%bf%b9%e4%b8%ad%e7%9a%84%e6%b5%81%e5%8a%a8">#</a>
</h3>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph LR
    A[推理服务器&lt;br/&gt;版本 v3] --&gt;|agenerate| B[ModelResponse&lt;br/&gt;output_versions: 3,3,3,...]
    B --&gt;|workflow.arun_episode| C[Trajectory&lt;br/&gt;versions: -1,-1,3,3,3,...]
    
    D[推理服务器&lt;br/&gt;版本 v4] --&gt;|agenerate&lt;br/&gt;中途更新| E[ModelResponse&lt;br/&gt;output_versions: 4,4,5,5,...]
    E --&gt;|workflow.arun_episode| F[Trajectory&lt;br/&gt;versions: -1,-1,4,4,5,5,...]
    
    C --&gt; G[Training Batch&lt;br/&gt;批次聚合]
    F --&gt; G
    
    G --&gt;|compute_advantages| H[PPOActor&lt;br/&gt;考虑版本差异]
    H --&gt;|ppo_update| I[权重更新&lt;br/&gt;新版本 v5]
    
    style A fill:#e1f5ff
    style D fill:#e1f5ff
    style I fill:#ffe6e6
</code></pre><hr>
<h2 id="5-decoupled-ppo-目标函数">
  5. Decoupled PPO 目标函数
  <a class="anchor" href="#5-decoupled-ppo-%e7%9b%ae%e6%a0%87%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>当启用 off-policy 训练时，AReaL 使用 Decoupled PPO 损失函数来处理版本差异。</p>
<h3 id="51-配置">
  5.1 配置
  <a class="anchor" href="#51-%e9%85%8d%e7%bd%ae">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">actor</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use_decoupled_loss</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 启用 Decoupled PPO</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">recompute_logprobs</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># 训练时重新计算 logprobs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prox_logp_method</span>: <span style="color:#e6db74">&#34;recompute&#34;</span> <span style="color:#75715e"># 近端策略的计算方法</span>
</span></span></code></pre></div><h3 id="52-三种-log-probability">
  5.2 三种 Log-Probability
  <a class="anchor" href="#52-%e4%b8%89%e7%a7%8d-log-probability">#</a>
</h3>
<p>在 Decoupled PPO 中，需要区分三种对数概率：</p>
<ol>
<li><strong>π_behave（行为策略）</strong>：rollout 时记录的 logprobs（从推理服务器）</li>
<li><strong>π_prox（近端策略）</strong>：训练开始时的策略（作为参考点）</li>
<li><strong>π_θ（当前策略）</strong>：训练过程中更新的策略</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PPOActor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_log_configuration</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>use_decoupled_loss:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Mode: Standard PPO (on-policy)&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>recompute_logprob:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;  old_logp (π_old): RECOMPUTED from current policy&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;  old_logp (π_old): FROM INFERENCE (cached during rollout)&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Mode: Decoupled PPO (off-policy)&#34;</span>)
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;  log_p_behave (π_behave): FROM INFERENCE (behavior policy)&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            method_descriptions <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;recompute&#34;</span>: <span style="color:#e6db74">&#34;RECOMPUTED via forward pass (standard decoupled PPO)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;loglinear&#34;</span>: <span style="color:#e6db74">&#34;LOG-LINEAR APPROXIMATION (no forward pass)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;metrics&#34;</span>: <span style="color:#e6db74">&#34;RECOMPUTED + APPROXIMATION METRICS (for evaluation)&#34;</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;  Proximal policy (π_prox): </span><span style="color:#e6db74">{</span>method_descriptions[config<span style="color:#f92672">.</span>prox_logp_method]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;  log_p_theta (π_θ): TRAINING FORWARD PASS (current policy)&#34;</span>)
</span></span></code></pre></div><h3 id="53-decoupled-损失计算">
  5.3 Decoupled 损失计算
  <a class="anchor" href="#53-decoupled-%e6%8d%9f%e5%a4%b1%e8%ae%a1%e7%ae%97">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ppo_actor_loss_fn</span>(<span style="color:#f92672">...</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> use_decoupled_loss:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 计算行为策略的重要性权重</span>
</span></span><span style="display:flex;"><span>        log_ratio_behav <span style="color:#f92672">=</span> logp_theta <span style="color:#f92672">-</span> log_p_behave
</span></span><span style="display:flex;"><span>        ratio_behav <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(log_ratio_behav)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 计算近端策略的比率（用于 PPO clip）</span>
</span></span><span style="display:flex;"><span>        log_ratio_prox <span style="color:#f92672">=</span> logp_theta <span style="color:#f92672">-</span> prox_logp
</span></span><span style="display:flex;"><span>        ratio_prox <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(log_ratio_prox)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decoupled PPO 目标</span>
</span></span><span style="display:flex;"><span>        surr1 <span style="color:#f92672">=</span> ratio_behav <span style="color:#f92672">*</span> advantages
</span></span><span style="display:flex;"><span>        surr2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>clamp(ratio_prox, <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> eps_clip, <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">+</span> eps_clip) <span style="color:#f92672">*</span> advantages
</span></span><span style="display:flex;"><span>        policy_loss <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>torch<span style="color:#f92672">.</span>min(surr1, surr2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 标准 PPO</span>
</span></span><span style="display:flex;"><span>        log_ratio <span style="color:#f92672">=</span> logp_theta <span style="color:#f92672">-</span> old_logp
</span></span><span style="display:flex;"><span>        ratio <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(log_ratio)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        surr1 <span style="color:#f92672">=</span> ratio <span style="color:#f92672">*</span> advantages
</span></span><span style="display:flex;"><span>        surr2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>clamp(ratio, <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> eps_clip, <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">+</span> eps_clip) <span style="color:#f92672">*</span> advantages
</span></span><span style="display:flex;"><span>        policy_loss <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>torch<span style="color:#f92672">.</span>min(surr1, surr2)
</span></span></code></pre></div><hr>
<h2 id="6-系统整体流程图">
  6. 系统整体流程图
  <a class="anchor" href="#6-%e7%b3%bb%e7%bb%9f%e6%95%b4%e4%bd%93%e6%b5%81%e7%a8%8b%e5%9b%be">#</a>
</h2>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TB
    subgraph &#34;1. 初始化阶段&#34;
        Init[初始化推理引擎和训练引擎]
        Init --&gt; LaunchServer[启动推理服务器&lt;br/&gt;SGLang/vLLM]
        LaunchServer --&gt; CreateSM[创建 StalenessManager&lt;br/&gt;max_staleness=4]
        CreateSM --&gt; CreateDispatcher[创建 BatchTaskDispatcher]
        CreateDispatcher --&gt; StartThreads[启动生产者/消费者线程]
    end
    
    subgraph &#34;2. 训练循环&#34;
        TrainStep[训练步骤 step]
        TrainStep --&gt; PrepareBatch[actor.prepare_batch&lt;br/&gt;收集 rollout 数据]
        
        PrepareBatch --&gt; CheckCapacity{检查容量}
        CheckCapacity --&gt;|capacity &gt; 0| SubmitTask[提交 rollout 任务]
        CheckCapacity --&gt;|capacity &lt;= 0| WaitCapacity[等待容量释放]
        WaitCapacity --&gt; CheckCapacity
        
        SubmitTask --&gt; RunWorkflow[执行 workflow.arun_episode]
        RunWorkflow --&gt; GenTokens[生成 tokens&lt;br/&gt;记录版本信息]
        
        GenTokens --&gt; CheckUpdate{权重更新中断?}
        CheckUpdate --&gt;|是| WaitUpdate[等待更新完成&lt;br/&gt;继续生成]
        WaitUpdate --&gt; GenTokens
        CheckUpdate --&gt;|否| CompleteGen[完成生成]
        
        CompleteGen --&gt; BuildTraj[构建轨迹&lt;br/&gt;包含版本张量]
        BuildTraj --&gt; AcceptReject{通过筛选?}
        AcceptReject --&gt;|是| CollectBatch[收集到批次]
        AcceptReject --&gt;|否| DiscardTraj[丢弃轨迹]
        
        CollectBatch --&gt; BatchReady{批次就绪?}
        BatchReady --&gt;|否| CheckCapacity
        BatchReady --&gt;|是| ComputeAdv[计算 Advantages]
        
        ComputeAdv --&gt; PPOUpdate[PPO 更新&lt;br/&gt;Decoupled Loss]
        PPOUpdate --&gt; UpdateLR[更新学习率]
        UpdateLR --&gt; SyncWeights[同步权重到推理服务器]
        SyncWeights --&gt; IncVersion[增加版本号&lt;br/&gt;version++]
        IncVersion --&gt; NextStep[下一步]
        NextStep --&gt; TrainStep
    end
    
    subgraph &#34;3. 并发控制&#34;
        SM[StalenessManager]
        SM --&gt; CalcCap[计算容量&lt;br/&gt;min(concurrency, staleness)]
        CalcCap --&gt; TrackState[跟踪 rollout 状态&lt;br/&gt;enqueued/running/accepted]
    end
    
    StartThreads --&gt; TrainStep
    PrepareBatch -.调用.-&gt; SM
    IncVersion -.更新.-&gt; SM
    
    style CheckUpdate fill:#ffe6e6
    style WaitUpdate fill:#ffe6e6
    style GenTokens fill:#e6f7ff
    style SyncWeights fill:#fff4e6
    style IncVersion fill:#fff4e6
</code></pre><hr>
<h2 id="7-关键设计要点总结">
  7. 关键设计要点总结
  <a class="anchor" href="#7-%e5%85%b3%e9%94%ae%e8%ae%be%e8%ae%a1%e8%a6%81%e7%82%b9%e6%80%bb%e7%bb%93">#</a>
</h2>
<h3 id="71-off-policyness-控制">
  7.1 Off-policyness 控制
  <a class="anchor" href="#71-off-policyness-%e6%8e%a7%e5%88%b6">#</a>
</h3>
<ol>
<li>
<p><strong>双重容量限制</strong>：</p>
<ul>
<li>并发限制：控制同时运行的 rollout 数量</li>
<li>过时性限制：确保样本不会过时到超过可接受范围</li>
</ul>
</li>
<li>
<p><strong>版本感知调度</strong>：</p>
<ul>
<li>生产者线程在提交任务前检查 <code>staleness_manager.get_capacity()</code></li>
<li>容量计算考虑当前版本和最大允许的版本差</li>
</ul>
</li>
<li>
<p><strong>状态跟踪</strong>：</p>
<ul>
<li>使用线程安全的计数器跟踪 rollout 生命周期</li>
<li>实时更新 <code>enqueued</code>、<code>running</code>、<code>accepted</code>、<code>rejected</code> 状态</li>
</ul>
</li>
</ol>
<h3 id="72-partial-rollouts-支持">
  7.2 Partial Rollouts 支持
  <a class="anchor" href="#72-partial-rollouts-%e6%94%af%e6%8c%81">#</a>
</h3>
<ol>
<li>
<p><strong>增量生成</strong>：</p>
<ul>
<li><code>agenerate</code> 方法支持中断和恢复</li>
<li>每次生成一段 tokens 后检查是否需要继续</li>
</ul>
</li>
<li>
<p><strong>版本记录</strong>：</p>
<ul>
<li><code>output_versions</code> 列表与 <code>output_tokens</code> 一一对应</li>
<li>记录每个 token 生成时的模型版本</li>
</ul>
</li>
<li>
<p><strong>版本传播</strong>：</p>
<ul>
<li>从 <code>ModelResponse</code> → <code>Workflow</code> → <code>Trajectory</code> → <code>Training Batch</code></li>
<li>训练时可以利用版本信息调整损失计算</li>
</ul>
</li>
</ol>
<h3 id="73-异步架构优势">
  7.3 异步架构优势
  <a class="anchor" href="#73-%e5%bc%82%e6%ad%a5%e6%9e%b6%e6%9e%84%e4%bc%98%e5%8a%bf">#</a>
</h3>
<ol>
<li>
<p><strong>高吞吐量</strong>：</p>
<ul>
<li>推理和训练并行执行</li>
<li>典型情况下比同步 RL 快 2 倍</li>
</ul>
</li>
<li>
<p><strong>GPU 利用率高</strong>：</p>
<ul>
<li>推理 GPU 持续生成数据</li>
<li>训练 GPU 持续更新模型</li>
</ul>
</li>
<li>
<p><strong>灵活的容错</strong>：</p>
<ul>
<li>支持中断和恢复</li>
<li>拒绝的 rollout 不会阻塞训练</li>
</ul>
</li>
</ol>
<hr>
<h2 id="8-配置建议">
  8. 配置建议
  <a class="anchor" href="#8-%e9%85%8d%e7%bd%ae%e5%bb%ba%e8%ae%ae">#</a>
</h2>
<h3 id="81-调试场景">
  8.1 调试场景
  <a class="anchor" href="#81-%e8%b0%83%e8%af%95%e5%9c%ba%e6%99%af">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rollout</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_head_offpolicyness</span>: <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 完全同步，便于调试</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_concurrent_rollouts</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">actor</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use_decoupled_loss</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">recompute_logprob</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h3 id="82-高吞吐量场景">
  8.2 高吞吐量场景
  <a class="anchor" href="#82-%e9%ab%98%e5%90%9e%e5%90%90%e9%87%8f%e5%9c%ba%e6%99%af">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rollout</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_head_offpolicyness</span>: <span style="color:#ae81ff">6</span>   <span style="color:#75715e"># 允许更多异步</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_concurrent_rollouts</span>: <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">consumer_batch_size</span>: <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">actor</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use_decoupled_loss</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">recompute_logprob</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prox_logp_method</span>: <span style="color:#e6db74">&#34;loglinear&#34;</span>  <span style="color:#75715e"># 使用近似避免额外前向传播</span>
</span></span></code></pre></div><h3 id="83-稳定性优先场景">
  8.3 稳定性优先场景
  <a class="anchor" href="#83-%e7%a8%b3%e5%ae%9a%e6%80%a7%e4%bc%98%e5%85%88%e5%9c%ba%e6%99%af">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rollout</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_head_offpolicyness</span>: <span style="color:#ae81ff">2</span>   <span style="color:#75715e"># 较小的异步度</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_concurrent_rollouts</span>: <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">actor</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">use_decoupled_loss</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">recompute_logprob</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prox_logp_method</span>: <span style="color:#e6db74">&#34;recompute&#34;</span>  <span style="color:#75715e"># 精确计算近端策略</span>
</span></span></code></pre></div><hr>
<h2 id="9-参考资料">
  9. 参考资料
  <a class="anchor" href="#9-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99">#</a>
</h2>
<ul>
<li>
<p><strong>代码位置</strong>：</p>
<ul>
<li><code>areal/core/staleness_manager.py</code>: Off-policyness 控制</li>
<li><code>areal/core/workflow_executor.py</code>: 任务调度和执行</li>
<li><code>areal/core/remote_inf_engine.py</code>: 推理引擎和增量生成</li>
<li><code>areal/engine/ppo/actor.py</code>: Decoupled PPO 实现</li>
</ul>
</li>
<li>
<p><strong>文档</strong>：</p>
<ul>
<li><a href="docs/algorithms/async.md">Asynchronous RL Guide</a></li>
<li><a href="docs/lite/gsm8k_grpo.md">GSM8K GRPO Example</a></li>
<li><a href="https://arxiv.org/pdf/2505.24298">AReaL Paper</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="附录代码示例">
  附录：代码示例
  <a class="anchor" href="#%e9%99%84%e5%bd%95%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b">#</a>
</h2>
<h3 id="a1-完整的训练循环示例">
  A.1 完整的训练循环示例
  <a class="anchor" href="#a1-%e5%ae%8c%e6%95%b4%e7%9a%84%e8%ae%ad%e7%bb%83%e5%be%aa%e7%8e%af%e7%a4%ba%e4%be%8b">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 初始化</span>
</span></span><span style="display:flex;"><span>rollout <span style="color:#f92672">=</span> RemoteSGLangEngine(config<span style="color:#f92672">.</span>rollout)
</span></span><span style="display:flex;"><span>rollout<span style="color:#f92672">.</span>initialize(train_data_parallel_size<span style="color:#f92672">=</span>parallel_strategy<span style="color:#f92672">.</span>dp_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>actor <span style="color:#f92672">=</span> FSDPPPOActor(config<span style="color:#f92672">=</span>config<span style="color:#f92672">.</span>actor)
</span></span><span style="display:flex;"><span>actor<span style="color:#f92672">.</span>create_process_group(parallel_strategy<span style="color:#f92672">=</span>parallel_strategy)
</span></span><span style="display:flex;"><span>actor<span style="color:#f92672">.</span>initialize(<span style="color:#66d9ef">None</span>, ft_spec)
</span></span><span style="display:flex;"><span>actor<span style="color:#f92672">.</span>connect_engine(rollout, weight_update_meta)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 训练循环</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> global_step <span style="color:#f92672">in</span> range(max_steps):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. 收集 rollout 数据（异步）</span>
</span></span><span style="display:flex;"><span>    batch <span style="color:#f92672">=</span> actor<span style="color:#f92672">.</span>prepare_batch(
</span></span><span style="display:flex;"><span>        train_dataloader,
</span></span><span style="display:flex;"><span>        group_size<span style="color:#f92672">=</span>config<span style="color:#f92672">.</span>gconfig<span style="color:#f92672">.</span>n_samples,
</span></span><span style="display:flex;"><span>        workflow<span style="color:#f92672">=</span>workflow,
</span></span><span style="display:flex;"><span>        should_accept_fn<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> sample: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># batch 包含 &#39;versions&#39; 字段，形状 [batch_size, seq_len]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2. 重新计算 logprobs（如果需要）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> config<span style="color:#f92672">.</span>actor<span style="color:#f92672">.</span>recompute_logprob:
</span></span><span style="display:flex;"><span>        logp <span style="color:#f92672">=</span> actor<span style="color:#f92672">.</span>compute_logp(batch)
</span></span><span style="display:flex;"><span>        batch[<span style="color:#e6db74">&#34;prox_logp&#34;</span>] <span style="color:#f92672">=</span> logp
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3. 计算参考 logprobs（用于 KL 惩罚）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ref <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        batch[<span style="color:#e6db74">&#34;ref_logp&#34;</span>] <span style="color:#f92672">=</span> ref<span style="color:#f92672">.</span>compute_logp(batch)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 4. 计算 Advantages</span>
</span></span><span style="display:flex;"><span>    actor<span style="color:#f92672">.</span>compute_advantages(batch)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 5. PPO 更新</span>
</span></span><span style="display:flex;"><span>    actor<span style="color:#f92672">.</span>ppo_update(batch)
</span></span><span style="display:flex;"><span>    actor<span style="color:#f92672">.</span>step_lr_scheduler()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 6. 同步权重到推理服务器</span>
</span></span><span style="display:flex;"><span>    rollout<span style="color:#f92672">.</span>pause()  <span style="color:#75715e"># 暂停 rollout 避免竞争</span>
</span></span><span style="display:flex;"><span>    actor<span style="color:#f92672">.</span>update_weights(weight_update_meta)
</span></span><span style="display:flex;"><span>    actor<span style="color:#f92672">.</span>set_version(global_step <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    rollout<span style="color:#f92672">.</span>set_version(global_step <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    rollout<span style="color:#f92672">.</span>resume()  <span style="color:#75715e"># 恢复 rollout</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 7. 日志和评估</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> global_step <span style="color:#f92672">%</span> eval_interval <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        evaluator<span style="color:#f92672">.</span>evaluate(actor, valid_dataloader, global_step)
</span></span><span style="display:flex;"><span>    saver<span style="color:#f92672">.</span>save(actor, global_step)
</span></span></code></pre></div><h3 id="a2-自定义-workflow-示例">
  A.2 自定义 Workflow 示例
  <a class="anchor" href="#a2-%e8%87%aa%e5%ae%9a%e4%b9%89-workflow-%e7%a4%ba%e4%be%8b">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomWorkflow</span>(RolloutWorkflow):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">arun_episode</span>(self, engine: InferenceEngine, data: dict[str, Any]):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 准备输入</span>
</span></span><span style="display:flex;"><span>        input_ids <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tokenizer<span style="color:#f92672">.</span>apply_chat_template(
</span></span><span style="display:flex;"><span>            data[<span style="color:#e6db74">&#34;messages&#34;</span>], tokenize<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, add_generation_prompt<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 生成响应（支持 partial rollouts）</span>
</span></span><span style="display:flex;"><span>        req <span style="color:#f92672">=</span> ModelRequest(
</span></span><span style="display:flex;"><span>            rid<span style="color:#f92672">=</span>uuid<span style="color:#f92672">.</span>uuid4()<span style="color:#f92672">.</span>hex,
</span></span><span style="display:flex;"><span>            input_ids<span style="color:#f92672">=</span>input_ids,
</span></span><span style="display:flex;"><span>            gconfig<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>gconfig,
</span></span><span style="display:flex;"><span>            tokenizer<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>tokenizer,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> engine<span style="color:#f92672">.</span>agenerate(req)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 计算奖励</span>
</span></span><span style="display:flex;"><span>        prompt_str <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tokenizer<span style="color:#f92672">.</span>decode(resp<span style="color:#f92672">.</span>input_tokens)
</span></span><span style="display:flex;"><span>        completion_str <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>tokenizer<span style="color:#f92672">.</span>decode(resp<span style="color:#f92672">.</span>output_tokens)
</span></span><span style="display:flex;"><span>        reward <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>async_reward_fn(prompt_str, completion_str, <span style="color:#f92672">**</span>data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 构建轨迹（包含版本信息）</span>
</span></span><span style="display:flex;"><span>        seq <span style="color:#f92672">=</span> resp<span style="color:#f92672">.</span>input_tokens <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_tokens
</span></span><span style="display:flex;"><span>        logprobs <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> resp<span style="color:#f92672">.</span>input_len <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_logprobs
</span></span><span style="display:flex;"><span>        loss_mask <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> resp<span style="color:#f92672">.</span>input_len <span style="color:#f92672">+</span> [<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> resp<span style="color:#f92672">.</span>output_len
</span></span><span style="display:flex;"><span>        versions <span style="color:#f92672">=</span> [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> resp<span style="color:#f92672">.</span>input_len <span style="color:#f92672">+</span> resp<span style="color:#f92672">.</span>output_versions  <span style="color:#75715e"># 关键：传播版本信息</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;input_ids&#34;</span>: torch<span style="color:#f92672">.</span>tensor(seq, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;logprobs&#34;</span>: torch<span style="color:#f92672">.</span>tensor(logprobs, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;loss_mask&#34;</span>: torch<span style="color:#f92672">.</span>tensor(loss_mask, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;versions&#34;</span>: torch<span style="color:#f92672">.</span>tensor(versions, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>int32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;rewards&#34;</span>: torch<span style="color:#f92672">.</span>tensor(reward, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;attention_mask&#34;</span>: torch<span style="color:#f92672">.</span>ones(len(seq), dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>bool)<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#areal-中的-off-policyness-与-partial-rollouts-实现详解">AReaL 中的 Off-policyness 与 Partial Rollouts 实现详解</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#1-off-policyness-控制机制">1. Off-policyness 控制机制</a>
          <ul>
            <li><a href="#11-配置参数">1.1 配置参数</a></li>
            <li><a href="#12-stalenessmanager-核心实现">1.2 StalenessManager 核心实现</a></li>
          </ul>
        </li>
        <li><a href="#2-partial-rollouts部分轨迹实现">2. Partial Rollouts（部分轨迹）实现</a>
          <ul>
            <li><a href="#21-版本跟踪机制">2.1 版本跟踪机制</a></li>
            <li><a href="#22-workflow-中的版本处理">2.2 Workflow 中的版本处理</a></li>
          </ul>
        </li>
        <li><a href="#3-异步任务调度与分发">3. 异步任务调度与分发</a>
          <ul>
            <li><a href="#31-batchtaskdispatcher-架构">3.1 BatchTaskDispatcher 架构</a></li>
            <li><a href="#32-生产者线程容量感知的任务提交">3.2 生产者线程：容量感知的任务提交</a></li>
            <li><a href="#33-消费者线程结果收集">3.3 消费者线程：结果收集</a></li>
          </ul>
        </li>
        <li><a href="#4-完整流程图">4. 完整流程图</a>
          <ul>
            <li><a href="#41-off-policyness-控制流程">4.1 Off-policyness 控制流程</a></li>
            <li><a href="#42-partial-rollouts-处理流程">4.2 Partial Rollouts 处理流程</a></li>
            <li><a href="#43-版本信息在轨迹中的流动">4.3 版本信息在轨迹中的流动</a></li>
          </ul>
        </li>
        <li><a href="#5-decoupled-ppo-目标函数">5. Decoupled PPO 目标函数</a>
          <ul>
            <li><a href="#51-配置">5.1 配置</a></li>
            <li><a href="#52-三种-log-probability">5.2 三种 Log-Probability</a></li>
            <li><a href="#53-decoupled-损失计算">5.3 Decoupled 损失计算</a></li>
          </ul>
        </li>
        <li><a href="#6-系统整体流程图">6. 系统整体流程图</a></li>
        <li><a href="#7-关键设计要点总结">7. 关键设计要点总结</a>
          <ul>
            <li><a href="#71-off-policyness-控制">7.1 Off-policyness 控制</a></li>
            <li><a href="#72-partial-rollouts-支持">7.2 Partial Rollouts 支持</a></li>
            <li><a href="#73-异步架构优势">7.3 异步架构优势</a></li>
          </ul>
        </li>
        <li><a href="#8-配置建议">8. 配置建议</a>
          <ul>
            <li><a href="#81-调试场景">8.1 调试场景</a></li>
            <li><a href="#82-高吞吐量场景">8.2 高吞吐量场景</a></li>
            <li><a href="#83-稳定性优先场景">8.3 稳定性优先场景</a></li>
          </ul>
        </li>
        <li><a href="#9-参考资料">9. 参考资料</a></li>
        <li><a href="#附录代码示例">附录：代码示例</a>
          <ul>
            <li><a href="#a1-完整的训练循环示例">A.1 完整的训练循环示例</a></li>
            <li><a href="#a2-自定义-workflow-示例">A.2 自定义 Workflow 示例</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












